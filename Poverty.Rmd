---
title: "Poverty VS Incidence Rate"
author: "Chenhui Yan"
date: "2024-12-02"
output: github_document
---
```{r}
library(dplyr)
library(plotly)
library(ggplot2)

```

## Poverty
Is there an association between the percentage of people whose income is below the poverty line and the incidence rate 1) across neighborhoods in NYC and 2) across neighborhoods in each borough?


```{r}

data_clean <- read.csv("data_final.csv")
# List all column names
names(data_clean)

# Check the structure of the data frame
str(data_clean)


# Step 1: Check the structure of your dataset to ensure the necessary columns exist
head(data_clean)

```
## Poverty across neighborhoods in NYC

```{r}
# Calculate the correlation between the poverty percentage and the incident rate
correlation <- cor(data_clean$incident_rate_by_year_nta, data_clean$Percent_poverty, use = "complete.obs")
print(paste("Correlation coefficient: ", correlation))

```
When examining all of the neighborhoods in NYC, there is a moderate positive linear relationship between the percentage of people below the poverty line (Percent_poverty) and the incident rate by neighborhood (incident_rate_by_year_nta).(r = 0.508).


```{r}
# Create a scatter plot to visualize the relationship
data_clean %>%
  plot_ly(x = ~Percent_poverty, y = ~incident_rate_by_year_nta, 
          color = ~NTA, colors = "viridis", 
          type = "scatter", mode = "markers",
          text = ~paste("Neighborhood: ", NTA, "<br>Borough: ", BORO, 
                        "<br>% Below Poverty Line: ", Percent_poverty, 
                        "<br>Incident Rate: ", incident_rate_by_year_nta)) %>%
  layout(title = "Percent Below the Poverty Line and Incident Rate in NYC",
         xaxis = list(title = 'Percentage of People Whose Income is Below the Poverty Line'),
         yaxis = list(title = 'Incident Rate'),
         legend = list(title = list(text = 'Neighborhood')))
```

this plot suggests that neighborhoods with higher poverty rates tend to have higher incident rates, with some variability. This relationship may point towards socio-economic factors that influence the safety and well-being of neighborhoods in NYC.

## Poverty By Borough
```{r}
# Assuming your main data frame is named 'data_clean'

# Filter data for Manhattan
manhattan_data <- data_clean %>%
  filter(neighbourhood_group == "Manhattan")

# Filter data for Brooklyn
brooklyn_data <- data_clean %>%
  filter(neighbourhood_group == "Brooklyn")

# Filter data for The Bronx
bronx_data <- data_clean %>%
  filter(neighbourhood_group == "Bronx")

# Filter data for Staten Island
staten_island_data <- data_clean %>%
  filter(neighbourhood_group == "Staten Island")

# Filter data for Queens
queens_data <- data_clean %>%
  filter(neighbourhood_group == "Queens")

```

```{r}
# Function to compute and print correlation
compute_correlation <- function(data, borough_name) {
  correlation <- cor(
    data$incident_rate_by_year_nta,
    data$Percent_poverty,
    use = "complete.obs"
  )
  cat("Correlation coefficient for", borough_name, ":", correlation, "\n")
}

compute_correlation(manhattan_data, "Manhattan")
compute_correlation(brooklyn_data, "Brooklyn")
compute_correlation(bronx_data, "Bronx")
compute_correlation(staten_island_data, "Staten Island")
compute_correlation(queens_data, "Queens")

```

### Manhattan
```{r}
compute_correlation(manhattan_data, "Manhattan")
# Function to create scatter plot with trend line
# Scatter plot for Manhattan
data_clean |> 
  filter(neighbourhood_group == "Manhattan") |> 
  plot_ly(data = _, x = ~Percent_poverty, y = ~incident_rate_by_year_nta, 
          color = ~NTA,
          colors = "viridis", 
          type = "scatter",
          mode = "markers",
          text = ~paste("Neighborhood: ", NTA, "<br>Borough: ", neighbourhood_group, 
                        "<br>% Below Poverty Line: ", Percent_poverty, 
                        "<br>Incident Rate: ", incident_rate_by_year_nta)) |> 
    layout(title = "Percent Below the Poverty Line and Incident Rate in Manhattan",
           xaxis = list(title = 'Percentage of People Whose Income is Below the Poverty Line'),
           yaxis = list(title = 'Incident Rate'),
           legend = list(title = list(text = 'Neighborhood')))

```
### Brooklyn
```{r}
# Scatter plot for Brooklyn
data_clean |> 
  filter(neighbourhood_group == "Brooklyn") |> 
  plot_ly(data = _, x = ~Percent_poverty, y = ~incident_rate_by_year_nta, 
          color = ~NTA,
          colors = "plasma", 
          type = "scatter",
          mode = "markers",
          text = ~paste("Neighborhood: ", NTA, "<br>Borough: ", neighbourhood_group, 
                        "<br>% Below Poverty Line: ", Percent_poverty, 
                        "<br>Incident Rate: ", incident_rate_by_year_nta)) |> 
    layout(title = "Percent Below the Poverty Line and Incident Rate in Brooklyn",
           xaxis = list(title = 'Percentage of People Whose Income is Below the Poverty Line'),
           yaxis = list(title = 'Incident Rate'),
           legend = list(title = list(text = 'Neighborhood')))

```
### The Bronx
```{r}
# Scatter plot for The Bronx
data_clean |> 
  filter(neighbourhood_group == "Bronx") |> 
  plot_ly(data = _, x = ~Percent_poverty, y = ~incident_rate_by_year_nta, 
          color = ~NTA,
          colors = "magma", 
          type = "scatter",
          mode = "markers",
          text = ~paste("Neighborhood: ", NTA, "<br>Borough: ", neighbourhood_group, 
                        "<br>% Below Poverty Line: ", Percent_poverty, 
                        "<br>Incident Rate: ", incident_rate_by_year_nta)) |> 
    layout(title = "Percent Below the Poverty Line and Incident Rate in The Bronx",
           xaxis = list(title = 'Percentage of People Whose Income is Below the Poverty Line'),
           yaxis = list(title = 'Incident Rate'),
           legend = list(title = list(text = 'Neighborhood')))

```
### Queens
```{r}
# Scatter plot for Queens
data_clean |> 
  filter(neighbourhood_group == "Queens") |> 
  plot_ly(data = _, x = ~Percent_poverty, y = ~incident_rate_by_year_nta, 
          color = ~NTA,
          colors = "inferno", 
          type = "scatter",
          mode = "markers",
          text = ~paste("Neighborhood: ", NTA, "<br>Borough: ", neighbourhood_group, 
                        "<br>% Below Poverty Line: ", Percent_poverty, 
                        "<br>Incident Rate: ", incident_rate_by_year_nta)) |> 
    layout(title = "Percent Below the Poverty Line and Incident Rate in Queens",
           xaxis = list(title = 'Percentage of People Whose Income is Below the Poverty Line'),
           yaxis = list(title = 'Incident Rate'),
           legend = list(title = list(text = 'Neighborhood')))

```
### Staten Island
```{r}
# Scatter plot for Staten Island
data_clean |> 
  filter(neighbourhood_group == "Staten Island") |> 
  plot_ly(data = _, x = ~Percent_poverty, y = ~incident_rate_by_year_nta, 
          color = ~NTA,
          colors = "inferno", 
          type = "scatter",
          mode = "markers",
          text = ~paste("Neighborhood: ", NTA, "<br>Borough: ", neighbourhood_group, 
                        "<br>% Below Poverty Line: ", Percent_poverty, 
                        "<br>Incident Rate: ", incident_rate_by_year_nta)) |> 
    layout(title = "Percent Below the Poverty Line and Incident Rate in Staten Island",
           xaxis = list(title = 'Percentage of People Whose Income is Below the Poverty Line'),
           yaxis = list(title = 'Incident Rate'),
           legend = list(title = list(text = 'Neighborhood')))

```


```{r}
library(dplyr)
library(plotly)


incidents_data <- read.csv("data_final.csv")


incidents_filtered <- incidents_data %>%
  filter(Year >= 2017 & Year <= 2023)

# Aggregate total incidents by CDTA
incidents_by_cdta <- incidents_filtered %>%
  group_by(CDTA) %>%
  summarise(
    total_incidents = n(),
    # Calculate average Longitude and Latitude for each CDTA
    Longitude = mean(Longitude, na.rm = TRUE),
    Latitude = mean(Latitude, na.rm = TRUE)
  ) %>%
  ungroup()

# Define initial breaks from 0 to 400 with intervals of 5
initial_breaks <- seq(0, 400, by = 5)


max_incidents <- max(incidents_by_cdta$total_incidents, na.rm = TRUE)


if (max_incidents > 400) {
  # Extend breaks to include all incidents > 400
  extended_breaks <- c(initial_breaks, Inf)
  
  # Create labels for all intervals, including the last one for incidents >400
  labels <- c(
    paste(initial_breaks[-length(initial_breaks)], initial_breaks[-1], sep = "-"),
    paste0("401+", max_incidents)
  )
} else {
  
  extended_breaks <- initial_breaks
  labels <- paste(initial_breaks[-length(initial_breaks)], initial_breaks[-1], sep = "-")
}

# Validate that the number of labels matches the number of intervals
num_intervals <- length(extended_breaks) - 1
num_labels <- length(labels)

if (num_intervals != num_labels) {
  stop("Number of labels does not match the number of intervals.")
}

# Assign incident ranges
incidents_by_cdta <- incidents_by_cdta %>%
  mutate(
    incident_range = cut(
      total_incidents,
      breaks = extended_breaks,
      include.lowest = TRUE,
      right = FALSE,  # Left-inclusive intervals [a, b)
      labels = labels
    )
  )


print(table(incidents_by_cdta$incident_range, useNA = "ifany"))

# Check for missing coordinates and exclude them
missing_coords <- incidents_by_cdta %>%
  filter(is.na(Longitude) | is.na(Latitude))

if (nrow(missing_coords) > 0) {
  cat("Warning: The following CDTAs have missing coordinates and will be excluded from the plot:\n")
  print(missing_coords$CDTA)
  
  # Exclude CDTAs with missing coordinates
  incidents_by_cdta <- incidents_by_cdta %>%
    filter(!is.na(Longitude) & !is.na(Latitude))
}


# Replace 'your_mapbox_access_token' with your actual token from Mapbox
Sys.setenv('MAPBOX_TOKEN' = 'your_mapbox_access_token')  # IMPORTANT: Replace with your token

# Create the scatter map
incident_map <- plot_ly(
  data = incidents_by_cdta,
  type = "scattermapbox",
  mode = "markers",
  lon = ~Longitude,  # Use exact column name
  lat = ~Latitude,   # Use exact column name
  color = ~incident_range,
  colors = "inferno",  # Choose a valid color scale
  marker = list(
    size = 8,
    opacity = 0.7
  ),
  text = ~paste(
    "CDTA: ", CDTA,
    "<br>Total Incidents: ", total_incidents,
    "<br>Incident Range: ", incident_range
  )
) %>%
  layout(
    title = "Total Number of Incidents Across NYC CDTAs (2017-2023)",
    mapbox = list(
      style = "carto-positron",  # Map style
      center = list(lon = -74.0060, lat = 40.7128),  # Centered on NYC
      zoom = 10
    ),
    legend = list(title = list(text = 'Incident Range'))
  )


incident_map

```







