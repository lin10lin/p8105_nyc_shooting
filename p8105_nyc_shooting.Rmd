---
title: "p8105_nyc_shooting"
output: html_document
date: "2024-11-19"
---
```{r, message=FALSE}
library(sf)
library(dplyr)
library(readr)
library(stringr)
library(lubridate)
library(timeDate)

```
# This part focus on data cleaning, tidying and merging.
## adding neighborhood information to the shooting dataset
```{r, message=FALSE}
df=read_csv("NYPD_Shooting_Incident_Data__Historic__20241119.csv")

# Ensure coordinate columns are numeric
df = df %>%
  mutate(
    X_COORD_CD = as.numeric(X_COORD_CD),
    Y_COORD_CD = as.numeric(Y_COORD_CD)
  )

# Convert to sf object with CRS EPSG:2263
df_sf = st_as_sf(df, coords = c("X_COORD_CD", "Y_COORD_CD"), crs = 2263)

# Download and read the GeoJSON file
download.file(
  url = "https://data.insideairbnb.com/united-states/ny/new-york-city/2024-09-04/visualisations/neighbourhoods.geojson",
  destfile = "neighbourhoods.geojson",
  mode = "wb"
)
neighbourhoods = st_read("neighbourhoods.geojson")

# Check and transform CRS of neighborhoods
if (st_crs(neighbourhoods)$epsg != 2263) {
  neighbourhoods = st_transform(neighbourhoods, crs = 2263)
}

# Perform the spatial join
df_joined = st_join(df_sf, neighbourhoods, left = TRUE)

# Add neighborhood information to the data frame
df$Neighborhood = df_joined$neighbourhood

# Download and use the neighborhoods CSV file
download.file(
  url = "https://data.insideairbnb.com/united-states/ny/new-york-city/2024-09-04/visualisations/neighbourhoods.csv",
  destfile = "neighbourhoods.csv",
  mode = "wb"
)
neighborhoods_csv = read_csv("neighbourhoods.csv")

# Merge additional attributes if necessary
df = df %>%
  left_join(neighborhoods_csv, by = c("Neighborhood" = "neighbourhood"))

```
## add time information
for future study, i need to add variables related to date and time of the gunshot incidence.
```{r}
df$OCCUR_DATE <- as.Date(df$OCCUR_DATE, format = "%m/%d/%Y")

# Define the range of years, handling NA values
years <- seq(
  year(min(df$OCCUR_DATE, na.rm = TRUE)),
  year(max(df$OCCUR_DATE, na.rm = TRUE)),
  by = 1
)
us_holidays = holidayNYSE(years)
us_holidays = as.Date(us_holidays)
# Add a new column indicating whether the date is a holiday
df = df %>%
  mutate(
    Is_Holiday = OCCUR_DATE %in% us_holidays
  )
write.csv(df, "data_with_holidays.csv", row.names = FALSE)